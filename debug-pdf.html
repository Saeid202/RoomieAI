<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #results { margin-top: 20px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß PDF Debug Tool</h1>
    
    <div class="test-section info">
        <h3>üìã Instructions</h3>
        <p>This tool will help us find your PDF file. Click the buttons below to test different aspects.</p>
    </div>

    <div class="test-section">
        <h3>üß™ Test PDF System</h3>
        <button onclick="testSupabaseConnection()">1. Test Supabase Connection</button>
        <button onclick="testStorageBuckets()">2. Test Storage Buckets</button>
        <button onclick="testOntarioFolder()">3. Test Ontario Folder</button>
        <button onclick="testPdfDownload()">4. Test PDF Download</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="results"></div>

    <script type="module">
        // Import Supabase (you'll need to adjust this path)
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        // Your Supabase credentials
        const SUPABASE_URL = "https://bjesofgfbuyzjamyliys.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqZXNvZmdmYnV5emphbXlsaXlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMDcxOTcsImV4cCI6MjA2Nzc4MzE5N30.V0RSLBpoCehRW_CjIwfOmIm0iJio3Y2auDBoFyjUfOs";
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        window.testSupabaseConnection = async function() {
            addResult("üîÑ Testing Supabase connection...", "info");
            
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                addResult(`‚úÖ Supabase connected! User: ${user ? 'Logged in' : 'Not logged in'}`, "success");
                if (error) addResult(`Auth error: ${error.message}`, "error");
            } catch (error) {
                addResult(`‚ùå Supabase connection failed: ${error.message}`, "error");
            }
        };
        
        window.testStorageBuckets = async function() {
            addResult("üîÑ Testing storage buckets...", "info");
            
            try {
                const { data: buckets, error } = await supabase.storage.listBuckets();
                
                if (error) {
                    addResult(`‚ùå Error listing buckets: ${error.message}`, "error");
                    return;
                }
                
                if (!buckets || buckets.length === 0) {
                    addResult("‚ùå No storage buckets found!", "error");
                    return;
                }
                
                addResult(`‚úÖ Found ${buckets.length} buckets:`, "success");
                buckets.forEach(bucket => {
                    addResult(`  - ${bucket.id} (public: ${bucket.public})`, "info");
                });
                
            } catch (error) {
                addResult(`‚ùå Storage test failed: ${error.message}`, "error");
            }
        };
        
        window.testOntarioFolder = async function() {
            addResult("üîÑ Testing Ontario folder in all buckets...", "info");
            
            try {
                const { data: buckets } = await supabase.storage.listBuckets();
                
                for (const bucket of buckets) {
                    addResult(`Checking bucket: ${bucket.id}`, "info");
                    
                    const { data: files, error } = await supabase.storage
                        .from(bucket.id)
                        .list('Ontario');
                    
                    if (error) {
                        addResult(`  No Ontario folder in ${bucket.id}`, "info");
                        continue;
                    }
                    
                    if (files && files.length > 0) {
                        addResult(`‚úÖ Found Ontario folder in ${bucket.id}:`, "success");
                        files.forEach(file => {
                            addResult(`  - ${file.name} (${file.metadata?.size || 'unknown size'} bytes)`, "info");
                        });
                    } else {
                        addResult(`  Ontario folder empty in ${bucket.id}`, "info");
                    }
                }
                
            } catch (error) {
                addResult(`‚ùå Ontario folder test failed: ${error.message}`, "error");
            }
        };
        
        window.testPdfDownload = async function() {
            addResult("üîÑ Testing PDF download...", "info");
            
            try {
                const { data: buckets } = await supabase.storage.listBuckets();
                
                for (const bucket of buckets) {
                    const { data: files } = await supabase.storage
                        .from(bucket.id)
                        .list('Ontario');
                    
                    if (files && files.length > 0) {
                        const pdfFiles = files.filter(f => f.name.toLowerCase().endsWith('.pdf'));
                        
                        if (pdfFiles.length > 0) {
                            const pdfFile = pdfFiles[0];
                            const pdfPath = `Ontario/${pdfFile.name}`;
                            
                            addResult(`Trying to download: ${bucket.id}/${pdfPath}`, "info");
                            
                            const { data: pdfData, error: pdfError } = await supabase.storage
                                .from(bucket.id)
                                .download(pdfPath);
                            
                            if (pdfError) {
                                addResult(`‚ùå Download failed: ${pdfError.message}`, "error");
                            } else {
                                addResult(`‚úÖ PDF downloaded successfully! Size: ${pdfData.size} bytes`, "success");
                                
                                // Test public URL
                                const { data: { publicUrl } } = supabase.storage
                                    .from(bucket.id)
                                    .getPublicUrl(pdfPath);
                                
                                addResult(`Public URL: ${publicUrl}`, "info");
                                
                                // Test if we can fetch it
                                try {
                                    const response = await fetch(publicUrl);
                                    addResult(`Public URL test: ${response.status} ${response.statusText}`, response.ok ? "success" : "error");
                                } catch (fetchError) {
                                    addResult(`Public URL fetch error: ${fetchError.message}`, "error");
                                }
                                
                                return; // Found and tested a PDF, stop here
                            }
                        }
                    }
                }
                
                addResult("‚ùå No PDF files found in any Ontario folder", "error");
                
            } catch (error) {
                addResult(`‚ùå PDF download test failed: ${error.message}`, "error");
            }
        };
        
        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        };
        
        function addResult(message, type) {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `<pre>${message}</pre>`;
            resultsDiv.appendChild(div);
        }
        
        // Auto-run basic test on load
        window.onload = function() {
            addResult("üöÄ PDF Debug Tool Loaded", "info");
            addResult("Click the buttons above to test your PDF system step by step", "info");
        };
    </script>
</body>
</html>
