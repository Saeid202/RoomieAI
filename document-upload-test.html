<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Upload Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>🧪 Rental Document Upload Test</h1>
    
    <div class="test-section">
        <h2>Step 1: Setup Database & Storage</h2>
        <p>First, run this SQL script in your Supabase SQL Editor:</p>
        <div class="code-block" id="setup-sql">
-- Copy and paste the contents of quick-setup-rental-documents.sql
-- This will create the storage bucket, database table, and RLS policies
        </div>
        <button onclick="copySetupSQL()">Copy Setup SQL</button>
    </div>

    <div class="test-section">
        <h2>Step 2: Test System Components</h2>
        <p>Open your browser console (F12) and run this test:</p>
        <div class="code-block" id="test-code">
// Copy and paste the contents of test-document-system.js
// This will test all components of the document system
        </div>
        <button onclick="copyTestCode()">Copy Test Code</button>
    </div>

    <div class="test-section">
        <h2>Step 3: Test Document Upload</h2>
        <p>Navigate to your rental application page and try uploading a document:</p>
        <ol>
            <li>Go to a rental application form</li>
            <li>Fill out the required fields</li>
            <li>Upload a test document (PDF, JPG, PNG)</li>
            <li>Check browser console for upload progress</li>
            <li>Check Supabase Dashboard > Storage for uploaded files</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>Step 4: Verify Results</h2>
        <div id="test-results">
            <p>Run the tests above and check the results here:</p>
        </div>
    </div>

    <div class="test-section">
        <h2>Common Issues & Solutions</h2>
        <div class="info">
            <strong>Storage bucket not found:</strong> Run the setup SQL script
        </div>
        <div class="info">
            <strong>Table rental_documents does not exist:</strong> Run the setup SQL script
        </div>
        <div class="info">
            <strong>Permission denied:</strong> Check RLS policies in setup script
        </div>
        <div class="info">
            <strong>User not authenticated:</strong> Ensure user is logged in
        </div>
    </div>

    <script>
        function copySetupSQL() {
            const sqlContent = `-- Quick setup for rental documents system
-- Run this in Supabase SQL Editor to ensure document saving works

-- =====================================================
-- 1. CREATE STORAGE BUCKET (if not exists)
-- =====================================================
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'rental-documents',
  'rental-documents', 
  false, -- Private bucket
  10485760, -- 10MB limit
  ARRAY['application/pdf', 'image/jpeg', 'image/png', 'image/gif', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']
)
ON CONFLICT (id) DO UPDATE SET
  public = false,
  file_size_limit = 10485760,
  allowed_mime_types = ARRAY['application/pdf', 'image/jpeg', 'image/png', 'image/gif', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];

-- =====================================================
-- 2. CREATE DATABASE TABLE (if not exists)
-- =====================================================
CREATE TABLE IF NOT EXISTS public.rental_documents (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    application_id UUID NOT NULL,
    document_type VARCHAR(50) NOT NULL CHECK (document_type IN ('reference', 'employment', 'credit', 'additional')),
    original_filename VARCHAR(255) NOT NULL,
    storage_url TEXT NOT NULL,
    file_size_bytes INTEGER NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    description TEXT,
    status VARCHAR(20) DEFAULT 'uploaded' CHECK (status IN ('uploaded', 'verified', 'rejected')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Add foreign key constraint if it doesn't exist
DO $$ 
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints 
        WHERE constraint_name = 'rental_documents_application_id_fkey'
        AND table_name = 'rental_documents'
    ) THEN
        ALTER TABLE public.rental_documents 
        ADD CONSTRAINT rental_documents_application_id_fkey 
        FOREIGN KEY (application_id) REFERENCES public.rental_applications(id) ON DELETE CASCADE;
    END IF;
END $$;

-- =====================================================
-- 3. CREATE INDEXES
-- =====================================================
CREATE INDEX IF NOT EXISTS idx_rental_documents_application_id ON public.rental_documents(application_id);
CREATE INDEX IF NOT EXISTS idx_rental_documents_type ON public.rental_documents(document_type);
CREATE INDEX IF NOT EXISTS idx_rental_documents_status ON public.rental_documents(status);

-- =====================================================
-- 4. ENABLE RLS AND CREATE POLICIES
-- =====================================================
ALTER TABLE public.rental_documents ENABLE ROW LEVEL SECURITY;

-- Drop existing policies
DROP POLICY IF EXISTS "Users can view documents for own applications" ON public.rental_documents;
DROP POLICY IF EXISTS "Users can insert documents for own applications" ON public.rental_documents;
DROP POLICY IF EXISTS "Users can update own application documents" ON public.rental_documents;
DROP POLICY IF EXISTS "Users can delete own application documents" ON public.rental_documents;

-- Create new policies
CREATE POLICY "Users can view documents for own applications" ON public.rental_documents
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM public.rental_applications 
            WHERE rental_applications.id = rental_documents.application_id 
            AND rental_applications.applicant_id = auth.uid()
        )
    );

CREATE POLICY "Users can insert documents for own applications" ON public.rental_documents
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM public.rental_applications 
            WHERE rental_applications.id = rental_documents.application_id 
            AND rental_applications.applicant_id = auth.uid()
        )
    );

CREATE POLICY "Users can update own application documents" ON public.rental_documents
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM public.rental_applications 
            WHERE rental_applications.id = rental_documents.application_id 
            AND rental_applications.applicant_id = auth.uid()
        )
    );

CREATE POLICY "Users can delete own application documents" ON public.rental_documents
    FOR DELETE USING (
        EXISTS (
            SELECT 1 FROM public.rental_applications 
            WHERE rental_applications.id = rental_documents.application_id 
            AND rental_applications.applicant_id = auth.uid()
        )
    );

-- =====================================================
-- 5. STORAGE BUCKET POLICIES
-- =====================================================
ALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;

-- Drop existing storage policies
DROP POLICY IF EXISTS "Tenants can upload their own rental documents" ON storage.objects;
DROP POLICY IF EXISTS "Tenants can view their own rental documents" ON storage.objects;
DROP POLICY IF EXISTS "Tenants can delete their own rental documents" ON storage.objects;

-- Create storage policies
CREATE POLICY "Tenants can upload their own rental documents" ON storage.objects
FOR INSERT WITH CHECK (
  bucket_id = 'rental-documents' 
  AND auth.uid()::text = (storage.foldername(name))[1]
);

CREATE POLICY "Tenants can view their own rental documents" ON storage.objects
FOR SELECT USING (
  bucket_id = 'rental-documents' 
  AND auth.uid()::text = (storage.foldername(name))[1]
);

CREATE POLICY "Tenants can delete their own rental documents" ON storage.objects
FOR DELETE USING (
  bucket_id = 'rental-documents' 
  AND auth.uid()::text = (storage.foldername(name))[1]
);

-- =====================================================
-- 6. VERIFICATION
-- =====================================================
SELECT 'Setup completed successfully!' as status;

-- Check bucket
SELECT 'Storage bucket status:' as info, name, public, file_size_limit FROM storage.buckets WHERE name = 'rental-documents';

-- Check table structure
SELECT 'Database table columns:' as info, column_name, data_type FROM information_schema.columns WHERE table_name = 'rental_documents' ORDER BY ordinal_position;

-- Check policies
SELECT 'RLS policies created:' as info, policyname FROM pg_policies WHERE tablename = 'rental_documents';`;
            
            navigator.clipboard.writeText(sqlContent).then(() => {
                alert('Setup SQL copied to clipboard!');
            });
        }

        function copyTestCode() {
            const testContent = `// Comprehensive test for rental document system
// Run this in browser console to check the current state

console.log('🧪 Testing Rental Document System...');

// Test 1: Check Supabase client
console.log('1. Checking Supabase client...');
if (typeof window.supabase !== 'undefined') {
  console.log('✅ Supabase client available');
} else {
  console.log('❌ Supabase client not available');
  console.log('Please ensure you are on a page that loads Supabase');
}

// Test 2: Check user authentication
console.log('2. Checking user authentication...');
async function checkAuth() {
  try {
    const { data: { user }, error } = await window.supabase.auth.getUser();
    if (error || !user) {
      console.log('❌ User not authenticated:', error?.message || 'No user');
      return false;
    }
    console.log('✅ User authenticated:', user.id);
    return true;
  } catch (err) {
    console.log('❌ Auth check failed:', err);
    return false;
  }
}

// Test 3: Check storage bucket
console.log('3. Checking storage bucket...');
async function checkStorage() {
  try {
    const { data, error } = await window.supabase.storage
      .from('rental-documents')
      .list('', { limit: 1 });
    
    if (error) {
      console.log('❌ Storage bucket error:', error.message);
      if (error.message.includes('not found')) {
        console.log('💡 Storage bucket does not exist - need to run setup script');
      }
      return false;
    }
    console.log('✅ Storage bucket accessible');
    return true;
  } catch (err) {
    console.log('❌ Storage check failed:', err);
    return false;
  }
}

// Test 4: Check database table
console.log('4. Checking database table...');
async function checkDatabase() {
  try {
    const { data, error } = await window.supabase
      .from('rental_documents')
      .select('id')
      .limit(1);
    
    if (error) {
      console.log('❌ Database table error:', error.message);
      if (error.message.includes('does not exist')) {
        console.log('💡 Database table does not exist - need to run setup script');
      }
      return false;
    }
    console.log('✅ Database table accessible');
    return true;
  } catch (err) {
    console.log('❌ Database check failed:', err);
    return false;
  }
}

// Test 5: Check rental applications table
console.log('5. Checking rental applications table...');
async function checkApplications() {
  try {
    const { data, error } = await window.supabase
      .from('rental_applications')
      .select('id')
      .limit(1);
    
    if (error) {
      console.log('❌ Rental applications error:', error.message);
      return false;
    }
    console.log('✅ Rental applications table accessible');
    return true;
  } catch (err) {
    console.log('❌ Applications check failed:', err);
    return false;
  }
}

// Test 6: Test document upload function
console.log('6. Testing document upload function...');
async function testUploadFunction() {
  try {
    // Check if the upload function exists
    if (typeof window.uploadRentalDocument === 'function') {
      console.log('✅ Upload function available');
      return true;
    } else {
      console.log('❌ Upload function not available');
      console.log('💡 Make sure you are on the rental application page');
      return false;
    }
  } catch (err) {
    console.log('❌ Upload function test failed:', err);
    return false;
  }
}

// Run all tests
async function runAllTests() {
  console.log('🚀 Running comprehensive document system tests...');
  
  const results = {
    auth: await checkAuth(),
    storage: await checkStorage(),
    database: await checkDatabase(),
    applications: await checkApplications(),
    uploadFunction: await testUploadFunction()
  };
  
  console.log('📊 Test Results:', results);
  
  const allPassed = Object.values(results).every(result => result === true);
  
  if (allPassed) {
    console.log('🎉 All tests passed! Document system is ready.');
    console.log('💡 You can now test document upload in the rental application form.');
  } else {
    console.log('❌ Some tests failed. Issues found:');
    
    if (!results.auth) {
      console.log('🔐 Authentication issue - please log in');
    }
    if (!results.storage) {
      console.log('☁️ Storage bucket issue - run setup_rental_documents_storage_complete.sql');
    }
    if (!results.database) {
      console.log('🗄️ Database table issue - run setup_rental_documents_storage_complete.sql');
    }
    if (!results.applications) {
      console.log('📋 Applications table issue - check rental_applications table exists');
    }
    if (!results.uploadFunction) {
      console.log('⚙️ Upload function issue - navigate to rental application page');
    }
    
    console.log('💡 Fix the issues above and run this test again.');
  }
  
  return results;
}

// Auto-run tests
runAllTests();`;
            
            navigator.clipboard.writeText(testContent).then(() => {
                alert('Test code copied to clipboard!');
            });
        }
    </script>
</body>
</html>
